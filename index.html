<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ü•î Potato Benchmark ‚Äî MongoDB vs Redis vs Cassandra</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface-2: #16213e;
      --mongo: #00ed64;
      --mongo-idx: #a8ff78;
      --redis: #ff4438;
      --cassandra: #1da1f2;
      --text: #e0e0e0;
      --text-muted: #8892b0;
      --accent: #64ffda;
      --border: rgba(100, 255, 218, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-2) 100%);
      padding: 2.5rem 2rem;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }
    .header h1 {
      font-size: 2.2rem;
      font-weight: 800;
      background: linear-gradient(90deg, var(--mongo), var(--mongo-idx), var(--redis), var(--cassandra));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }
    .header p { color: var(--text-muted); font-size: 1rem; }

    /* Tabs */
    .tabs-nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: center;
      gap: 2rem;
      padding: 0 2rem;
    }
    .tab-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 1.2rem 1rem;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      transition: color 0.3s;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--accent); }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 1.2rem;
      padding: 1.2rem 2rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .stat-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.7rem 1rem;
      background: var(--surface-2);
      border-radius: 12px;
      border: 1px solid var(--border);
      min-width: 100px;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-card .value { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
    .stat-card .label {
      font-size: 0.65rem; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 1px; margin-top: 0.15rem;
    }

    .main { max-width: 1400px; margin: 0 auto; padding: 2rem; }

    /* Report Styles */
    .report-wrap {
      background: var(--surface);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 3rem;
      line-height: 1.7;
    }
    .report-wrap h2 { font-size: 2rem; color: var(--accent); margin: 2rem 0 1rem; }
    .report-wrap h3 { font-size: 1.4rem; color: var(--text); margin: 2.5rem 0 1rem; border-left: 4px solid var(--accent); padding-left: 1rem; }
    .report-wrap p { margin-bottom: 1.2rem; color: var(--text); font-size: 1.05rem; }
    .report-wrap ul { margin: 1rem 0 2rem 2rem; color: var(--text-muted); }
    .report-wrap li { margin-bottom: 0.5rem; }
    .report-img {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin: 1.5rem 0 3rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .highlight { color: var(--accent); font-weight: 600; }

    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .scenario-card {
      background: var(--surface);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 1.5rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .scenario-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }
    .scenario-card h3 { font-size: 1rem; font-weight: 600; color: var(--accent); margin-bottom: 0.3rem; }
    .scenario-card .desc { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; }
    .scenario-card .chart-wrap { position: relative; height: 220px; }
    .scenario-card .winner-tag {
      display: inline-block; margin-top: 0.8rem;
      padding: 0.2rem 0.7rem; border-radius: 999px;
      font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .winner-mongo { background: rgba(0, 237, 100, 0.15); color: var(--mongo); }
    .winner-mongoIdx { background: rgba(168, 255, 120, 0.15); color: var(--mongo-idx); }
    .winner-redis { background: rgba(255, 68, 56, 0.15); color: var(--redis); }
    .winner-cassandra { background: rgba(29, 161, 242, 0.15); color: var(--cassandra); }

    .overview-section {
      background: var(--surface);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .overview-section h2 { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--accent); }
    .chart-container { position: relative; height: 420px; }

    .table-section {
      background: var(--surface);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 2rem;
      margin-bottom: 2rem;
      overflow-x: auto;
    }
    .table-section h2 { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--accent); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.65rem 0.7rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    td { font-size: 0.85rem; }
    .c-mongo { color: var(--mongo); font-weight: 600; }
    .c-mongoIdx { color: var(--mongo-idx); font-weight: 600; }
    .c-redis { color: var(--redis); font-weight: 600; }
    .c-cassandra { color: var(--cassandra); font-weight: 600; }
    .badge {
      display: inline-block; padding: 0.15rem 0.5rem;
      border-radius: 999px; font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
    }
    .badge-mongo { background: rgba(0, 237, 100, 0.15); color: var(--mongo); }
    .badge-mongoIdx { background: rgba(168, 255, 120, 0.15); color: var(--mongo-idx); }
    .badge-redis { background: rgba(255, 68, 56, 0.15); color: var(--redis); }
    .badge-cassandra { background: rgba(29, 161, 242, 0.15); color: var(--cassandra); }

    .footer { text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.8rem; }

    .loading { display: flex; justify-content: center; align-items: center; min-height: 60vh; flex-direction: column; gap: 1rem; }
    .spinner { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-box {
      background: rgba(255, 68, 56, 0.1); border: 1px solid rgba(255, 68, 56, 0.3);
      border-radius: 12px; padding: 2rem; text-align: center; color: var(--redis);
    }
    .error-box code { display: block; margin-top: 1rem; padding: 1rem; background: var(--surface-2); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted); }
  </style>
</head>
<body>

<div class="header">
  <h1>ü•î Potato Benchmark</h1>
  <p>MongoDB vs MongoDB (Index√©) vs Redis vs Cassandra ‚Äî Comparaison CRUD compl√®te</p>
</div>

<div class="tabs-nav">
  <button class="tab-btn active" onclick="switchTab('report')">üìñ Rapport d'Analyse</button>
  <button class="tab-btn" onclick="switchTab('benchmark')">üìä D√©tails Techniques</button>
</div>

<div id="report-tab" class="tab-content active">
  <div class="main">
    <div class="report-wrap">
      <h1>üìã Rapport de Benchmark NoSQL : Volume Extr√™me</h1>
      <p>Ce rapport d√©taille les performances de trois architectures de stockage face √† un volume de donn√©es massif : <span class="highlight">10 000 patates</span> et <span class="highlight">~45 Millions de matchs</span>.</p>

      <img src="screenshots/dashboard_main.png" alt="Dashboard Principal" class="report-img">

      <h3>üöÄ Synth√®se des R√©sultats</h3>
      <p>Le benchmark met en √©vidence une sp√©cialisation forte entre les technologies choisies :</p>
      <ul>
        <li><span class="highlight" style="color:var(--redis)">Redis</span> domine largement sur la r√©activit√© en temps r√©el et les op√©rations atomiques (Leaderboards).</li>
        <li><span class="highlight" style="color:var(--mongo)">MongoDB</span> (avec indexation) reste la solution la plus polyvalente pour les requ√™tes analytiques complexes et les filtrages ad-hoc.</li>
        <li>Cassandra a √©t√© √©cart√© pour ce volume en raison de limitations mat√©rielles lors de l'ingestion massive.</li>
      </ul>

      <img src="screenshots/overview_log.png" alt="Vue d'ensemble logarithmique" class="report-img">

      <h3>üìä Analyse des Op√©rations CRUD</h3>
      <p>L'utilisation des <strong>Sorted Sets</strong> dans Redis permet d'obtenir le Top 10 des winrates en seulement <span class="highlight">24ms</span>, l√† o√π MongoDB n√©cessite plus de 110 secondes pour agr√©ger 45 millions de documents.</p>

      <img src="screenshots/crud_charts.png" alt="Graphiques CRUD" class="report-img">

      <h3>üîç Performances Analytiques</h3>
      <p>Pour les calculs de type <code>AVG</code>, <code>SUM</code> ou <code>GROUP BY</code>, MongoDB Indexed surpasse Redis (impl√©mentation client) par un facteur de 5. L'indexation sur MongoDB r√©duit le temps des recherches filtr√©es (SELECT WHERE) de <span class="highlight">31ms √† 6ms</span>.</p>

      <img src="screenshots/analytics_charts.png" alt="Graphiques Analytiques" class="report-img">

      <h3>üìù Conclusion Finale</h3>
      <p>Le choix de la base de donn√©es doit √™tre guid√© par le cas d'usage : <strong>Redis</strong> pour la v√©locit√© et les fonctionnalit√©s de ranking, <strong>MongoDB</strong> pour la flexibilit√© des requ√™tes et l'analyse de donn√©es massives.</p>

      <img src="screenshots/table_details.png" alt="Tableau D√©taill√©" class="report-img">
    </div>
  </div>
</div>

<div id="benchmark-tab" class="tab-content">
  <div id="stats-bar" class="stats-bar"></div>
  <div class="main" id="app">
    <div class="loading"><div class="spinner"></div><p>Chargement des r√©sultats...</p></div>
  </div>
</div>

<div class="footer"><p>Potato Benchmark ‚Äî Cours Opti BDD ‚Äî <span id="timestamp"></span></p></div>

<script>
  function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    if (tab === 'report') {
      document.querySelector('[onclick="switchTab(\'report\')"]').classList.add('active');
      document.getElementById('report-tab').classList.add('active');
    } else {
      document.querySelector('[onclick="switchTab(\'benchmark\')"]').classList.add('active');
      document.getElementById('benchmark-tab').classList.add('active');
      if (!window.chartRendered) loadAndRender();
    }
  }

  const DBS = [
    { key: 'mongoTimeMs',        label: 'MongoDB',          color: '#00ed64', bg: 'rgba(0, 237, 100, 0.7)',   cls: 'mongo' },
    { key: 'mongoIndexedTimeMs', label: 'MongoDB (Index√©)', color: '#a8ff78', bg: 'rgba(168, 255, 120, 0.7)', cls: 'mongoIdx' },
    { key: 'redisTimeMs',        label: 'Redis',            color: '#ff4438', bg: 'rgba(255, 68, 56, 0.7)',   cls: 'redis' },
    { key: 'cassandraTimeMs',    label: 'Cassandra',        color: '#1da1f2', bg: 'rgba(29, 161, 242, 0.7)',  cls: 'cassandra' },
  ];

  async function loadData() {
    try {
      const res = await fetch('./benchmark-results.json');
      if (!res.ok) throw new Error('not found');
      return await res.json();
    } catch { return null; }
  }

  function getWinner(r) {
    const candidates = DBS.filter(db => db.cls !== 'cassandra' && r[db.key] > 0);
    let best = candidates[0];
    for (const db of candidates) { 
      if (r[db.key] < r[best.key]) best = db; 
    }
    return best;
  }

  function renderStatsBar(data) {
    const bar = document.getElementById('stats-bar');
    const wins = {};
    DBS.forEach(db => wins[db.cls] = 0);
    data.results.forEach(r => wins[getWinner(r).cls]++);

    bar.innerHTML = `
      <div class="stat-card"><span class="value">${data.potatoCount.toLocaleString()}</span><span class="label">Patates</span></div>
      <div class="stat-card"><span class="value">${data.matchCount.toLocaleString()}</span><span class="label">Matchs</span></div>
      <div class="stat-card"><span class="value">${data.results.length}</span><span class="label">Sc√©narios</span></div>
      ${DBS.map(db => `<div class="stat-card"><span class="value" style="color:${db.color}">${wins[db.cls]}</span><span class="label">${db.label}</span></div>`).join('')}
    `;
  }

  function renderApp(data) {
    const app = document.getElementById('app');
    document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString('fr-FR');

    let cards = '';
    data.results.forEach((r, i) => {
      const w = getWinner(r);
      cards += `
        <div class="scenario-card">
          <h3>${r.scenario}</h3>
          <p class="desc">${r.description}</p>
          <div class="chart-wrap"><canvas id="chart-${i}"></canvas></div>
          <span class="winner-tag winner-${w.cls}">üèÜ ${w.label} (${r[w.key]}ms)</span>
        </div>`;
    });

    app.innerHTML = `
      <div class="scenario-grid">${cards}</div>
      <div class="overview-section">
        <h2>üìä Vue d'ensemble ‚Äî √©chelle logarithmique</h2>
        <div class="chart-container"><canvas id="overviewChart"></canvas></div>
      </div>
      <div class="table-section">
        <h2>üìã Tableau d√©taill√©</h2>
        <table>
          <thead><tr>
            <th>Sc√©nario</th><th>Description</th>
            ${DBS.map(db => `<th>${db.label} (ms)</th>`).join('')}
            <th>Gagnant</th>
          </tr></thead>
          <tbody id="detailsBody"></tbody>
        </table>
      </div>
    `;

    // Per-scenario charts
    data.results.forEach((r, i) => {
      new Chart(document.getElementById(`chart-${i}`), {
        type: 'bar',
        data: {
          labels: DBS.map(db => db.label),
          datasets: [{
            data: DBS.map(db => r[db.key]),
            backgroundColor: DBS.map(db => db.bg),
            borderColor: DBS.map(db => db.color),
            borderWidth: 2,
            borderRadius: 8,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#8892b0', font: { family: 'Inter', weight: '600', size: 10 } }, grid: { display: false } },
            y: { ticks: { color: '#8892b0' }, grid: { color: 'rgba(100,255,218,0.06)' }, title: { display: true, text: 'ms', color: '#8892b0' } },
          },
        },
      });
    });

    // Overview (log scale)
    new Chart(document.getElementById('overviewChart'), {
      type: 'bar',
      data: {
        labels: data.results.map(r => r.scenario),
        datasets: DBS.map(db => ({
          label: db.label,
          data: data.results.map(r => r[db.key]),
          backgroundColor: db.bg,
          borderColor: db.color,
          borderWidth: 2,
          borderRadius: 6,
        })),
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#e0e0e0', font: { family: 'Inter' } } } },
        scales: {
          x: { ticks: { color: '#8892b0', font: { size: 10 } }, grid: { color: 'rgba(100,255,218,0.05)' } },
          y: { type: 'logarithmic', ticks: { color: '#8892b0' }, grid: { color: 'rgba(100,255,218,0.08)' }, title: { display: true, text: 'Temps (ms) ‚Äî log', color: '#8892b0' } },
        },
      },
    });

    // Details table
    const tbody = document.getElementById('detailsBody');
    for (const r of data.results) {
      const w = getWinner(r);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${r.scenario}</strong></td>
        <td>${r.description}</td>
        ${DBS.map(db => `<td class="c-${db.cls}">${r[db.key].toLocaleString()}</td>`).join('')}
        <td><span class="badge badge-${w.cls}">üèÜ ${w.label}</span></td>
      `;
      tbody.appendChild(row);
    }
  }

  function renderError() {
    document.getElementById('app').innerHTML = `
      <div class="error-box">
        <h2>‚ö†Ô∏è Aucun r√©sultat trouv√©</h2>
        <p>Lancez le benchmark d'abord :</p>
        <code>npx ts-node --transpile-only benchmark/benchmark-engine.ts</code>
      </div>`;
  }

  async function loadAndRender() {
    const data = await loadData();
    if (!data) return renderError();
    renderStatsBar(data);
    renderApp(data);
    window.chartRendered = true;
  }

  // Initial load for timestamp at bottom
  (async () => {
    const data = await loadData();
    if (data) document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString('fr-FR');
  })();
</script>
</body>
</html>
